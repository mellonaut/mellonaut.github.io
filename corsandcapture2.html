<!DOCTYPE html>
<html>
<head>
    <title>CORS and Capture Part 1: Self-Hosting a CORS Proxy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #333;  /* Dark grey background */
            color: #fff;  /* White text color */
        }
        p.center-block {
            width: 75%;  /* or any width */
            margin: auto;
            text-align: center;
            /* border: 1px solid black;  Optional, to visualize the block */
            padding: 10px;  /* Optional, to add some space around the text */
        }
        .top-banner {
            text-align: center;
            position: relative;
            height: 33.33vh; /* This sets the height of the banner to be 1/3 of the viewport height. */
        }
        .top-banner img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* This property causes the image to be scaled and cropped to fill the banner. */
        }
        .top-banner div {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            transform: translateY(-50%);
            text-align: center;
            color: #fff;
        }
        .navbar {
            background-color: #867b7b;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .navbar a {
            float: left;
            display: block;
            color: #f2f2f2;
            border: 1px solid rgb(83, 83, 83);
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }
        .navbar a:hover {
            background-color: #ddd;
            color: black;
        }
        .code-snippet {
            width: 66%;
            margin: auto;
            /* border: 1px solid black; */
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #333;  /* Dark grey background */
            color: #fff;  /* White text color */
        }
        .code-snippet code .comment {
            color: #008000;  /* Green color for comments */
        }
        .content {
            width: 100%;
            text-align: center; /* Added this to center all text within the content div */
        }
        .article-image {
            width: 25%;
            height: auto;
            display: block;
            margin: 20px auto;
        }
        .text-box {
            width: 80%; /* Adjust width as needed */
            margin: 0 auto; /* Centers the box */
            padding: 20px;
            background-color: #f3f1f1;; /* Light grey background color */
            color: #000; /* Black text color */
            text-align: center; /* Aligns text to center */
            border-radius: 10px; /* Optional, to make the box corners rounded */
        }
        .codebox {
    /* Below are styles for the codebox (not the code itself) */
    border: 1px solid black;
    background-color: #EEEEFF;
    width: 300px;
    overflow: auto;
    padding: 10px;
    margin: 0 auto; /* Add this line to center the codebox */
}

.codebox code {
    /* Styles in here affect the text of the codebox */
    font-size: 1.2em;
    color: black; /* Set the font color to black */
    /* You can add additional styles here if needed */
}
    </style>
</head>
<!--  Start of Body -->
<!-- Navbar -->
<body>
    <div class="top-banner">
        <img src="assets/straylight.jpg" alt="Banner Image">
        <div>
            <h1>CORS and Capture Part 2: Proxy Wars</h1>
        </div>
    </div>
    <div class="navbar">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="red.html">Red</a>
        <a href="blue.html">Blue</a>
        <a href="cloud.html">Cloud</a>
        <a href="code.html">Code</a>
        <a href="posts.html">Posts</a>
    </div>
<!-- Content Starts Here -->
<!-- Content Starts Here -->
<div class="content">
    <img class="article-image" src="assets/cors/8020rule.png" alt="Article Image">        
    <div class="text-box">
        <p class="center-block">
            <h2>The 80/20 Rule</h2>
            My friend once told me that projects follow an 80/20 rule. 80% of your most important effort will go into the lat 20% of the project. 
            That 20% of the time accounts for 80% of the value of your project. I feel like I'm butchering the hell out of that but we're going to roll with it, feels right enough. 
            The first 80 percent of the project is fun and productive and morale is high.  Not that there won't be difficulties and stress or problems and redesigns, but the last 20% of a project is where it really sucks and where you learn the most. You're so over the project, you lose your shit at every git error and you're lost on troubleshooting. I think that was this past week and we're now close to the end. The last bit of the suck.
        </p>
    </div>
    <p></p>

    <div class="text-box">
        <p class="center-block">
            <h2> Where We're At</h2>
            <p></p>
            This is Part 2 of a series and you might be lost if you didn't read <a href="corsandcapture1.html">Part 1</a>. Last time, we started working on way to keep our device codes alive for phishing. 
            We got a working version of the lure, but ran into the problem of sending it with the Outlook client.  We had an EC2 serving CORS solely for url redirection from a good domain. 
            The domain had been working for email but hosting a site got blocked by web-filtering by categorization. We need to get our lure hosted on a better domain. 
            <!-- <img class="article-image" src="assets/cors/categorycheck1.png" alt="cors and capture 2"> -->
            <p></p>
        </p>
    </div>
    <p></p>

    <div class="text-box">
        <p class="center-block">
            <h2>Dog Party</h2>
            <p></p>
            We ran up against a wall hosting our dynamic lure. Everything was working fine but client's web-filtering has the domain categorized as pornography. 
            It was definitely not, and I requested re-categorization from that specific vendor but we need to pivot. I'm not sure what category my other domains are. 
            Let's go take a look and see if one of the three I already bought for this will work.
            <p></p>
            Here is a site you can use to check the category of a url:
            <a href="https://www.cyren.com/security-center/url-category-check-gate">Url Category Checker</a>
            <img class="article-image" src="assets/cors/categorycheck1.png" alt="Category">            
            <p></p>
            All of my current ones are 'unknown' or 'parked domain'. Let's head back over to expireddomains.net. 
            I highly suggest creating an account as you have way more options for searching. You can look for any TLD you want, .info is cheaper but .com seems more likely to be categorized.
            I still had to try for a bit.
            <p></p>
            <img class="article-image" src="assets/cors/expired1.png" alt="Category"> 
            <p></p>
            <img class="article-image" src="assets/cors/expired2.png" alt="Category">   
        </p>
    </div>
<p></p>
    <div class="text-box">
        <p class="center-block">
            <h2>Expired Domains</h2>
            Let's look at a good example.
            <p></p>
            Lemonwaterguide.com
            <img class="article-image" src="assets/cors/expired4.png" alt="Category">            
            <p></p>
            <img class="article-image" src="assets/cors/expired5.png" alt="Category"> 
            <p></p>
            <img class="article-image" src="assets/cors/categorycheck2.png" alt="Category">   
            <p></p>
            <img class="article-image" src="assets/cors/expired7.png" alt="Category">
            <p></p>
            For a breakdown of what all goes into these popularity rankings:
            <p></p>
            <a href="https://labs.ripe.net/author/samaneh_tajalizadehkhoob_1/the-tale-of-website-popularity-rankings-an-extensive-analysis/">The Tale of Website Popularity Rankings: An Extensive Analysis | RIPE Labs  </a>            
        </p>
    </div>
<p></p>
 <div class="text-box">
        <p class="center-block">
            <h2>Categories Revisited</h2>
            Prabably good enough for us, so let's see if it's categorized:
            <p></p>
            <img class="article-image" src="assets/cors/categorycheck3.png" alt="cors and capture 2">
            <p></p>
            It's categorized, but not into one that makes me hopeful we'll  bypass corporate filters (unless it is the c-suite).
            <p></p>
            Ultimately landed on a good reputation one categorized as "Religious", hoping that's a category that will provide some leeway. 
            We'll re-deploy with terraform/ansible and get a new IP and hostname then point an A Record to it for our new holy rollin' domain. 
            Once it's all in place, we'll have our contact try again and see they can access our page and see the lure. 
        </p>
    </div>
    
    <p></p>
    <div class="text-box">
        <p class="center-block">
            <h2> HTTPs and Updog </h2>
            <p></p>
            Let's grab a certificate for this site, we will need it at some point, even if Updog does what we need. 
            <p></p>
            I recommend certbot and LetsEncrypt, but you can do it manually, too,  if you hate yourself.
            Make sure you change the domain and sub to yours, run the command and make note of your cert path.

            <p></p>
            <div class="codebox">
                <code>   
                    <span class="comment"># Point a "www" record to your server and run certbot with http challenge for a letsencrypt cert</span>
                    <p></p>
                    domain="lemonwaterguide"
                    <p></p>
                    sudo certbot certonly --register-unsafely-without-email -d www.$domain.com  --standalone --preferred-challenges http --non-interactive --agree-tos   
                    <p></p>                                    
                </code>
            </div>
            <p></p>
            <img class="article-image" src="assets/cors/letsencrypt1.png" alt="cors and capture 2">
            <p></p>
            You'll find them in /etc/letsencrypt/live/www.$domain.com
                    <p></p>
                    I like to copy them to a folder in home called "certs"
                    <p></p>
                    <div class="codebox">
                        <code>   
                            <span class="comment"># Copy certs to our home folder for ease-of-use</span>
                            <p></p>
                            mkdir ~/certs
                            <p></p>
                            sudo cp -r   /etc/letsencrypt/live/www.$domain.com/* ~/certs/
                            <p></p>
                            ls ~/certs               
                        </code>
                    </div>
            <p></p>
            Updog has it's own SSL cert it uses when you use the '--ssl' option. I'd like to use ours but it's worth trying it out. 
            If we need to,  Nginx and another server written in Go called Gosh  let you use custom certs. 
            It also looks like Updog is just a flask application, a framework we're fairly comfortable with.
            <p></p>
            <img class="article-image" src="assets/cors/updog3.jpg.png" alt="cors and capture 2">
            <img class="article-image" src="assets/cors/updog4.png" alt="cors and capture 2">
            Note the similarities to the Capture server. Looks like we have a starting point if we feel the need to modify Updog, as well. In the morning our next objective is to test our new domain against the web-filter and the lure via Updog with SSL. 
            If that works, we'll register a certificate for the capture server and I'll show you how to deploy it. Once we have a fully encrypted setup that works for everything, we'll do one final teardown, resize the servers for cost then deploy again and finish the automation in the process. 
        </p>
    </div>


 <p></p>
    <div class="text-box">
        <p class="center-block">
            <h2>Whiskey in the Jar</h2>
            <p></p>
            Updog turned into more hassle than I had hoped for, and I recorded none of that. 
            It occurred to me later that using CORS and Updog behind caddy as a reverse proxy would've been a better use of time. 
            Trying that first, but I was just moving, and it may have turned into a rabbit hole we didn't need. I'm glad I did it, I learned a ton and will put some of what I made to use elsewhere. 
            I decided to take it's source code and strip it down to do the two tasks we need: serve static content and using our own SSL certficates. We'll add strict paths to it after we prototype.
            <img class="article-image" src="assets/cors/flask1.png" alt="cors and capture 2">
            <p></p>
            It's called supdog, for "simplistic updog" but at this point it's barely an app much less a clone of updog but I learned it from that project and I like stupid names.  
            All you have to do is copy your "cert.pem" and "privkey.pem" to the supdog folder. 
            Place static content in the same foldcer in "static" "content" and the filename.
            <img class="article-image" src="assets/cors/flask2.png" alt="cors and capture 2">
            <p></p>
            Perfect. That's our dynamic lure serving over SSL using our LetsEncrypt certificate. 
        </p>
    </div>  
<p></p> 
<!-- Content -->
<p></p>
    <div class="text-box">
        <p class="center-block">
            <h2>Live Test 2</h2>
            Set an A record for our server, and went to deploy againâ€¦but I could not get the page to work, even on a local server.
            I ended up creating a control file in the servers static folder using the flux-hosted CORS Anywhere:
            <p></p>
            <img class="article-image" src="assets/cors/lureserver1.png" alt="cors and capture 2">
            <p></p>
            You can use this to troubleshoot with the Chrome dev tools (F12)
            <p></p>
            <img class="article-image" src="assets/cors/lureserver2.png" alt="cors and capture 2">
            <p></p>
            Let's go update our small Flask server for this file:
            <p></p>
            <img class="article-image" src="assets/cors/flask3.png" alt="cors and capture 2">
            <p></p>
            Back in our "lure-server.js" inside "\lure-server\cors-anywhere\" we need to make some changes
            <p></p>
            Let's remove our headers, we can add them back if we need to later
            <p></p>
            <p></p>
            <img class="article-image" src="assets/cors/lureserver3.png" alt="cors and capture 2">
            <p></p>
            Test it live against a domain we want to redirect to.
            <p></p>
            Place <a href="https://cnn.com">CNN.com</a> at the end of your servers URL <a href="https://lure.trusteddomain.com/https://cnn.com">https://lure.trusteddomain.com/https://cnn.com</a>
            <img class="article-image" src="assets/cors/lureserver4.png" alt="cors and capture 2">
            <p></p>
            Needed to do some troubleshooting using the Console in developer tools:
            <p></p>
            <img class="article-image" src="assets/cors/mixed1.png" alt="cors and capture 2">
            <p></p>
            I think the reason it displays on the live server in VS Code but not here is that mixed content policy. 
            I guess now we need to get SSL working. I tried before, when working out the earlier parts of this and was unsuccessful. 
            It started turning into a time sink and I decided to pull out and work on another part of the project. 
            Now it's unavoidable and we don't really have an excuse anyway, except the time this all has taken. 
        <p></p>
        </p>
    </div>
<p></p>
<!-- Content -->
<p></p>
    <div class="text-box">
        <p class="center-block">
            <h2>Two Paths</h2>
            <p></p>
            We need an SSL proxy for this Cors-Anywhere. I think we need to look at the example we first saw in the Issues of the Cors-Anywhere repo. Someone was discussing this there when I was researching how to self host this thing. It didn't work out iof the box and I didn't have what it took to troubleshoot that. If I don't have it now I'm about to get it.
            <p></p>
            The reason this was working before is because I was hosting the second cors service on Capture server.
            Having our resources on a separate domain prevented the mixed content error. If I was in a rush to use it, that would be my next goal, re-deploy that and edit the javascript for the hosted lure.
            Let's call that plan C, for cop-out, and leave it with our patient parts. Let's see if we can get this running over SSL.
            <p></p>
            We need to edit the lure-server.js first (again) to run on port 8443. We're going to run Caddy a really cool reverse-proxy that will let us proxy traffic between our cors service and the world. We won't need the custom "straylight" headers and can run multiple services like flask and our node cors server like a backend on the same port.  
            <p></p>
            <img class="article-image" src="assets/cors/lureserver5.png" alt="cors and capture 2">
            <p></p>
            This works. It's a basic config. It adds the required headers we need. We could easily tell it here to add our custom headers if we want to.  I'll put in the "caddy" folder in the repo and call it "CORS-Caddyfile"
            <img class="article-image" src="assets/cors/caddy1.png" alt="cors and capture 2">
            <p></p>
            We have the proxy running on port 443 with our letencrypt certificate and the CORS service is being proxied successfully.
            <p></p>
            To be continued...
        </p>
    </div>
<!-- Content -->
<p></p>
    <div class="text-box">
        <div class="center-block">
            <h2>Automate, Automate Such a Simple Plan</h2>
            <h3>-Diversion-</h3>
            <p></p>
            I automate as I go, try to keep track of the shell commands that works and work with it all afterward. It comes with some experience to write it as you go but if you can start that habit early it will help you.
            Takes me a long time to learn things now, but I learn them deeper because I start automating early in my process. Gives you something to work on when you get stuck, too.
            <p></p>
            This looks awful, I'm still bad at CSS and code boxes are tricky. Copy this to your IDE:
            <p></p>
            <div class="codebox">
                <code>   
                    <span class="comment"># Capture Server TMUX Script</span>
                    <span class="comment"># Starts high-port CORS and Capture server in tmux sessions</span>
                    <p></p>
                    #!/bin/bash
                    <p></p>
                    delete_sessions=false
                    <p></p>
                    <span class="comment"># Parse command-line options</span>
                    <p></p>
                    while getopts ":d" option; do
                      case $option in
                        d)
                          delete_sessions=true
                          ;;
                        \?)
                          echo "Invalid option: -$OPTARG" >&2
                          exit 1
                          ;;
                      esac
                    done
                    <p></p>
                    <span class="comment"># Create or delete sessions based on the option</span>
                    <p></p>
                    if [ "$delete_sessions" = true ]; then
                      tmux kill-session -t cors 2>/dev/null
                      tmux kill-session -t capture 2>/dev/null
                    else
                    <p></p>
                    <span class="comment"># Create detached session "cors" and send commands</span> 
                    <p></p>  
                    tmux new-session -d -s cors
                      tmux send-keys -t cors "cd /home/azureuser/yourcorsanywhere/capture-server/cors-anywhere" Enter
                      tmux send-keys -t cors "npm install"
                      tmux send-keys -t cors "node cap-server.js" Enter
                      <p></p>
                      <span class="comment"># Create detached session "capture" and send commands</span>
                      <p></p> 
                      tmux new-session -d -s capture
                      tmux send-keys -t capture "cd /home/azureuser/yourcorsanywhere/capture-server" Enter
                      tmux send-keys -t capture "mkdir certs" Enter
                      tmux send-keys -t capture "cd certs" Enter
                      tmux send-keys -t capture "cp /home/azureuser/certs/* ." Enter
                      tmux send-keys -t capture "cd .. && sudo python3 capturetoken.py" Enter
                    fi
                    <p></p>
                </code>
            </div>
            <p></p>
            Make it look like this, the indentation is important. My suggestion is throw it right into chatGPT and say "Big Dawg, format this, it's a bash script, please."
            <p></p>
            It only works if you call it big dawg, though. Should fix the loop for you if you ask it nicely, or scream at it, as well.
            <p></p>
            <img class="article-image" src="assets/cors/tmux1.png" alt="cors and capture 2">
            <p></p>
        </p>
    </div>






    <p></p>
    <!-- Placeholder -->
    <div class="text-box">
        <p class="center-block">
            <h2>---</h2>
            <p></p>
            Check back tomorrow. Updated frequently.
            <img class="article-image" src="assets/background.png" alt="cors and capture 2">
            <p></p>
        </p>
    </div>

<!-- <--- resources ---> 
<p></p>
<div class="text-box">        
    <p class="center-block">
    <h2>Resources</h2>
    <a href="https://caddyserver.com/docs/quick-starts">Caddyfile Quick Starts - Helpful Docs for Caddy I used</a>
    <p></p>    
    <p></p>
    <a href="https://www.cyren.com/security-center/url-category-check-gate">Category Checker from the article</a>
    <p></p>
    <p></p>
    <a href="https://www.blackhillsinfosec.com/bypass-web-proxy-filtering/">    Good BHIS article about bypassing web-filtering that helped me with this</a>
    <p></p>
        </p>
</div>

<!-- End of Body -->
</body>
</html>
